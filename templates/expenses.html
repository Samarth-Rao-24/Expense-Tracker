{% extends 'base.html' %}
{% block title %}Expenses{% endblock %}

{% block content %}
<h2>Your Expenses</h2>

<!-- TOP GRID: FILTERS + SUMMARY -->
<div class="grid">

    <!-- FILTERS -->
    <div class="card">
        <h3>Filters</h3>
        <form method="post">
            <label>From</label>
            <input type="date" name="start_date"
                   value="{{ request.form.start_date or request.args.get('start_date') }}">

            <label>To</label>
            <input type="date" name="end_date"
                   value="{{ request.form.end_date or request.args.get('end_date') }}">

            <label>Category</label>
            <select name="category">
                <option value="" {% if not (request.form.category or request.args.get('category')) %}selected{% endif %}>All</option>
                <option value="Food" {% if (request.form.category or request.args.get('category')) == 'Food' %}selected{% endif %}>Food</option>
                <option value="Travel" {% if (request.form.category or request.args.get('category')) == 'Travel' %}selected{% endif %}>Travel</option>
                <option value="Shopping" {% if (request.form.category or request.args.get('category')) == 'Shopping' %}selected{% endif %}>Shopping</option>
                <option value="Bills" {% if (request.form.category or request.args.get('category')) == 'Bills' %}selected{% endif %}>Bills</option>
                <option value="Others" {% if (request.form.category or request.args.get('category')) == 'Others' %}selected{% endif %}>Others</option>
            </select>

            <button type="submit">Apply Filter</button>
        </form>
    </div>

    <!-- SUMMARY -->
    <div class="card">
        <h3>Total Spent</h3>
        <p class="total">‚Çπ{{ total }}</p>

        <h4>Category-wise Spending</h4>
        {% if category_totals %}
        <ul>
            {% for cat in category_totals %}
                <li>{{ cat['category'] }} : ‚Çπ{{ cat['total'] }}</li>
            {% endfor %}
        </ul>
        {% else %}
        <p>No summary available.</p>
        {% endif %}

        <!-- Export Button -->
        <a href="{{ url_for('export_csv') }}" class="btn">üîÑ Export CSV</a>
    </div>

</div>

<!-- EXPENSE TABLE -->
<div class="card full-width">
    <h3>Expense Details</h3>

    {% if expenses %}
    <table>
        <tr>
            <th>Date</th>
            <th>Category</th>
            <th>Amount</th>
            <th>Description</th>
            <th>Actions</th>
        </tr>

        {% for exp in expenses %}
        <tr>
            <td>{{ exp['expense_date'] }}</td>
            <td>{{ exp['category'] }}</td>
            <td>‚Çπ{{ exp['amount'] }}</td>
            <td>{{ exp['description'] }}</td>
            <td>
                <a href="{{ url_for('edit_expense', expense_id=exp['expense_id']) }}">‚úèÔ∏è Edit</a> |
                <a href="{{ url_for('delete_expense', expense_id=exp['expense_id']) }}"
                   onclick="return confirm('Are you sure?')">üóë Delete</a>
            </td>
        </tr>
        {% endfor %}
    </table>
    {% else %}
    <p>No expenses found for the selected filter.</p>
    {% endif %}
</div>

<!-- CHART -->
<div class="card full-width">
    <h3>Category-wise Spending (Chart)</h3>
    <canvas id="categoryChart"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const categories = [
        {% for cat in category_totals %}
            "{{ cat['category'] }}",
        {% endfor %}
    ];

    const totals = [
        {% for cat in category_totals %}
            {{ cat['total'] }},
        {% endfor %}
    ];

    new Chart(document.getElementById('categoryChart'), {
        type: 'bar',
        data: {
            labels: categories,
            datasets: [{
                label: 'Spending (‚Çπ)',
                data: totals,
                backgroundColor: '#2c3e50',
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
</script>
{% endblock %}